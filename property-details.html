<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Detalles de la Propiedad | Ubify</title>
  <meta name="description" content="Descripción detallada de la propiedad en Villa Ángela, Chaco. Contacta al propietario directamente." />
  <meta name="keywords" content="alquiler Villa Ángela, casas en venta Villa Ángela, propiedades Villa Ángela, inmobiliarias" />
  <link rel="icon" type="image/png" href="logo-negro-sinfondo-pestaña.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@700&display=swap" rel="stylesheet" />
  <style>
    body { 
      font-family: 'Montserrat', sans-serif; 
      background-color: #e5e7eb;
      color: #1f2937; 
    }
    h1, h2, h3, h4, .font-playfair {
      font-family: 'Montserrat', sans-serif;
      font-weight: 700;
      color: #1f2937;
    }
    .font-inter {
      font-family: 'Inter', sans-serif;
    }
    .text-shadow-subtle {
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }
    .property-card {
      background-color: #eff6ff;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
      padding: 1.5rem;
      min-height: 120px;
    }
    .property-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    .thumbnail {
      width: 80px;
      height: 60px;
      object-fit: cover;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .thumbnail:hover {
      transform: scale(1.05);
      box-shadow: 0 0 0 2px #2563eb;
    }
    .thumbnail.active {
      box-shadow: 0 0 0 2px #2563eb;
    }
    .carousel-image { 
      transition: opacity 0.5s ease-in-out;
      cursor: pointer;
    }
    .btn-primary {
      background-image: linear-gradient(to right, #2563eb, #1d4ed8);
      color: #ffffff;
      transition: background 0.3s ease;
    }
    .btn-primary:hover {
      background-image: linear-gradient(to right, #1d4ed8, #1e40af);
    }
    .btn-secondary {
      background-color: #10b981;
      color: #ffffff;
    }
    .btn-secondary:hover {
      background-color: #059669;
    }
    .btn-tertiary {
      background-color: #ffffff;
      color: #2563eb;
      border: 2px solid #2563eb;
      transition: all 0.3s ease;
    }
    .btn-tertiary:hover {
      background-color: #f0f5ff;
      transform: translateY(-2px);
    }
    .header-divider {
      height: 1px;
      background: linear-gradient(to right, transparent, rgba(0, 0, 0, 0.1), transparent);
    }
    @keyframes slide-in {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slide-out {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(20px); }
    }
    .animate-slide-in {
      animation: slide-in 0.3s ease-out forwards;
    }
    .animate-slide-out {
      animation: slide-out 0.3s ease-in forwards;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.8);
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
      border-radius: 0.5rem;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    .close {
      position: absolute;
      top: 20px;
      right: 30px;
      color: #fff;
      font-size: 30px;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.3s;
    }
    .close:hover {
      color: #bbb;
    }
    .favorite-btn {
      background-color: white;
      border-radius: 50%;
      width: 2rem;
      height: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: all 0.2s;
      border: none;
      cursor: pointer;
    }
    .favorite-btn:hover {
      background-color: #f0f0f0;
      transform: scale(1.1);
    }
    .favorite-btn.favorited {
      background-color: #ef4444;
    }
    .favorite-btn.favorited svg {
      fill: white;
      stroke: white;
    }
    .favorite-btn svg {
      width: 1.2rem;
      height: 1.2rem;
      stroke: #4b5563;
      fill: none;
    }
    @media (max-width: 640px) {
      .favorite-btn {
        width: 1.8rem;
        height: 1.8rem;
      }
    }
    .animate-ping {
      animation: ping 0.5s cubic-bezier(0, 0, 0.2, 1);
    }
    @keyframes ping {
      75%, 100% {
        transform: scale(1.2);
        opacity: 0.8;
      }
    }
    .animate-slide-up {
      animation: slideUp 0.3s ease-in-out;
    }
    .animate-slide-down {
      animation: slideDown 0.3s ease-in-out;
    }
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes slideDown {
      from { transform: translateY(0); opacity: 1; }
      to { transform: translateY(20px); opacity: 0; }
    }
    .loading-message {
      text-align: center;
      padding: 2rem;
      color: #4b5563;
      font-size: 1.2rem;
    }
    .error-message {
      text-align: center;
      padding: 2rem;
      color: #ef4444;
      font-size: 1.2rem;
    }
  </style>
</head>
<body class="bg-gray-200 text-gray-800 font-inter">
  <header class="bg-white shadow-sm">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-2">
      <div class="flex items-center justify-between">
        <a href="index.html" class="btn-tertiary px-2 sm:px-4 py-1 sm:py-2 rounded-full font-semibold text-xs sm:text-sm font-montserrat flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M9.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L7.414 9H15a1 1 0 110 2H7.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd" />
          </svg>
          Volver
        </a>
        <div class="flex-1 flex flex-col items-center text-center">
          <h1 id="modalTitle" class="text-xl sm:text-2xl font-montserrat font-semibold text-gray-800 mb-1 sm:mb-2 text-shadow-subtle"></h1>
          <p id="modalPrice" class="text-base sm:text-lg font-medium text-gray-800 mb-2 sm:mb-3 font-montserrat tracking-wide">
            <span id="modalCurrency"></span> <span id="modalPriceValue"></span>
          </p>
          <div class="flex justify-center gap-1 flex-wrap">
            <span id="modalTypeBadge" class="bg-blue-600 text-white px-2 py-0.5 rounded-full text-xs font-inter"></span>
            <span id="modalOperationBadge" class="bg-purple-600 text-white px-2 py-0.5 rounded-full text-xs font-inter"></span>
            <span id="modalLocationBadge" class="bg-gray-600 text-white px-2 py-0.5 rounded-full text-xs font-inter"></span>
          </div>
        </div>
        <div class="flex items-center space-x-3">
          <a href="favorites.html" class="text-blue-600 hover:text-blue-800 font-medium text-sm flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
            </svg>
            Ver favoritos
          </a>
          <button id="favoriteButton" class="favorite-btn" data-property-id="" aria-label="Añadir a favoritos">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
            </svg>
          </button>
        </div>
      </div>
      <div class="my-1"></div>
    </div>
  </header>
  <main id="mainContent" class="py-12 px-4 bg-gray-200">
    <div class="max-w-6xl mx-auto">
      <div id="loadingMessage" class="loading-message">Cargando detalles de la propiedad...</div>
      <div id="errorMessage" class="error-message hidden"></div>
      <div id="propertyDetails" class="hidden">
        <div class="relative rounded-xl overflow-hidden shadow-xl mb-6">
          <img id="mainImage" src="" alt="Imagen principal" class="w-full h-64 sm:h-96 md:h-[500px] object-cover carousel-image">
          <button onclick="prevImage()" class="absolute left-4 top-1/2 -translate-y-1/2 bg-gray-800 bg-opacity-70 text-white p-3 rounded-full hover:bg-gray-700 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
          </button>
          <button onclick="nextImage()" class="absolute right-4 top-1/2 -translate-y-1/2 bg-gray-800 bg-opacity-70 text-white p-3 rounded-full hover:bg-gray-700 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </button>
        </div>
        <div id="thumbnailContainer" class="flex justify-start gap-3 mt-4 overflow-x-auto pb-4 px-1"></div>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mt-8">
          <div class="property-card">
            <div class="flex items-center mb-2">
              <span class="text-2xl mr-3">📍</span>
              <div>
                <h3 class="text-sm text-gray-600 font-inter">Ubicación</h3>
                <p id="modalLocation" class="text-lg font-medium text-gray-800 font-montserrat"></p>
              </div>
            </div>
          </div>
          <div class="property-card">
            <div class="flex items-center mb-2">
              <span class="text-2xl mr-3">📏</span>
              <div>
                <h3 class="text-sm text-gray-600 font-inter">Metros cuadrados</h3>
                <p id="modalSquareMeters" class="text-lg font-medium text-gray-800 font-montserrat"></p>
              </div>
            </div>
          </div>
          <div class="property-card">
            <div class="flex items-center mb-2">
              <span class="text-2xl mr-3">🛏️</span>
              <div>
                <h3 class="text-sm text-gray-600 font-inter">Dormitorio/s</h3>
                <p id="modalBedrooms" class="text-lg font-medium text-gray-800 font-montserrat"></p>
              </div>
            </div>
          </div>
          <div class="property-card">
            <div class="flex items-center mb-2">
              <span class="text-2xl mr-3">🛁</span>
              <div>
                <h3 class="text-sm text-gray-600 font-inter">Baño/s</h3>
                <p id="modalBathrooms" class="text-lg font-medium text-gray-800 font-montserrat"></p>
              </div>
            </div>
          </div>
        </div>
        <div class="mt-10 border rounded-xl overflow-hidden shadow bg-white">
          <button onclick="window.toggleAccordion('desc')" class="w-full text-left px-6 py-4 bg-blue-100 hover:bg-blue-200 font-semibold flex justify-between items-center text-lg sm:text-xl font-montserrat">
            <span class="flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              Descripción
            </span>
            <span id="icon-desc" class="toggle-icon">+</span>
          </button>
          <div id="panel-desc" class="px-6 py-4 hidden text-gray-700 font-inter">
            <p id="modalDescription" class="leading-relaxed text-lg"></p>
          </div>
        </div>
        <div class="mt-6 border rounded-xl overflow-hidden shadow bg-white">
          <button onclick="window.toggleAccordion('contacto')" class="w-full text-left px-6 py-4 bg-green-100 hover:bg-green-200 font-semibold flex justify-between items-center text-lg sm:text-xl font-montserrat">
            <span class="flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
              </svg>
              Contactá al propietario
            </span>
            <span id="icon-contacto" class="toggle-icon">+</span>
          </button>
          <div id="panel-contacto" class="px-6 py-4 hidden text-gray-700 font-inter">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-6">
              <div class="space-y-2">
                <p id="modalOwner" class="text-lg font-medium text-gray-800 flex items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                  </svg>
                  <span id="ownerName"></span>
                </p>
                <p id="modalPhone" class="text-lg text-gray-600 flex items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                  </svg>
                  <span id="phoneNumber"></span>
                </p>
              </div>
              <div class="flex flex-col sm:flex-row gap-4 w-full sm:w-auto mt-4 sm:mt-0">
                <a id="modalWhatsApp" href="#" target="_blank" class="inline-flex items-center justify-center btn-secondary px-3 sm:px-8 py-2 sm:py-4 rounded-full font-semibold text-sm sm:text-lg font-montserrat">
                  <img src="https://cdn.jsdelivr.net/npm/simple-icons@v10/icons/whatsapp.svg" alt="WhatsApp" class="w-5 h-5 mr-2 invert" />
                  Contactar por WhatsApp
                </a>
                <button id="copyLinkButton" class="inline-flex items-center justify-center btn-primary px-3 sm:px-8 py-2 sm:py-4 rounded-full font-semibold text-sm sm:text-lg font-montserrat">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                  </svg>
                  Copiar enlace
                </button>
              </div>
            </div>
          </div>
        </div>
        <div id="imageModal" class="modal">
          <span class="close">×</span>
          <img class="modal-content" id="modalImage">
        </div>
      </div>
    </div>
  </main>
  <footer class="bg-gray-200 py-10 px-4">
    <div class="max-w-6xl mx-auto grid grid-cols-1 gap-8 sm:grid-cols-3 text-center sm:text-left">
      <div class="border-b sm:border-b-0 sm:border-r border-gray-300 pb-6 sm:pb-0 sm:pr-6">
        <h3 class="text-lg sm:text-xl font-montserrat font-semibold mb-4 text-gray-800">Ubify</h3>
        <p class="text-gray-600 text-sm sm:text-base font-inter">Propiedades en toda la zona. Encontrá tu espacio o publicá el tuyo.</p>
      </div>
      <div class="border-b sm:border-b-0 sm:border-r border-gray-300 pb-6 sm:pb-0 sm:pr-6">
        <h3 class="text-lg sm:text-xl font-montserrat font-semibold mb-4 text-gray-800">Contáctanos</h3>
        <p class="text-gray-600 text-sm sm:text-base font-inter mb-2">¿Querés publicar una propiedad?</p>
        <a href="https://wa.me/+543735308294?text=Hola,%20quiero%20publicar%20una%20propiedad%20en%20Ubify" target="_blank" class="inline-flex items-center justify-center bg-green-500 text-white px-4 py-2 rounded-lg font-semibold text-sm sm:text-base hover:bg-green-600 transition duration-300 font-inter">
          <img src="https://cdn.jsdelivr.net/npm/simple-icons@v10/icons/whatsapp.svg" alt="WhatsApp" class="w-5 h-5 mr-2 invert" />
          Quiero publicar
        </a>
      </div>
      <div>
        <h3 class="text-lg sm:text-xl font-montserrat font-semibold mb-4 text-gray-800">¡Seguinos!</h3>
        <div class="flex justify-center sm:justify-start space-x-6">
          <a href="https://www.instagram.com/" target="_blank" class="hover:scale-110 transition-transform">
            <img src="https://cdn.jsdelivr.net/npm/simple-icons@v10/icons/instagram.svg" alt="Instagram" class="w-6 h-6 text-[#E4405F]" />
          </a>
        </div>
      </div>
    </div>
    <div class="max-w-4xl mx-auto mt-6 text-center text-gray-500 text-xs sm:text-sm font-inter">
      <p>Ubify es una plataforma digital para la publicación de propiedades en toda la zona. No realiza intermediación inmobiliaria ni cobra comisiones por operaciones. Las negociaciones son responsabilidad exclusiva de las partes intervinientes.</p>
    </div>
    <p class="text-center text-gray-500 mt-2 text-xs sm:text-sm font-inter">© 2025 Ubify - Diseñado y desarrollado por Hostara.</p>
  </footer>
  <script src="app.js" type="module"></script>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { toggleFavoriteProperty, isPropertyInFavorites, updateFavoritesCounter, showToast } from "./app.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC0iRq9z-KJxjnX_4CpjEZrwvX0hjvPb1w",
      authDomain: "ubify-598fe.firebaseapp.com",
      projectId: "ubify-598fe",
      storageBucket: "ubify-598fe.appspot.com",
      messagingSenderId: "291570754705",
      appId: "1:291570754705:web:c458124db5954b58d34b30"
    };

    console.log("Inicializando Firebase...");
    const app = initializeApp(firebaseConfig);
    console.log("Firebase inicializado:", app);
    const db = getFirestore(app);

    let propertyId = null;

    function showLoading(show) {
      const loadingMessage = document.getElementById('loadingMessage');
      const propertyDetails = document.getElementById('propertyDetails');
      const errorMessage = document.getElementById('errorMessage');
      if (loadingMessage && propertyDetails && errorMessage) {
        loadingMessage.classList.toggle('hidden', !show);
        propertyDetails.classList.toggle('hidden', show);
        errorMessage.classList.add('hidden');
      }
    }

    function showError(message) {
      const loadingMessage = document.getElementById('loadingMessage');
      const propertyDetails = document.getElementById('propertyDetails');
      const errorMessage = document.getElementById('errorMessage');
      if (loadingMessage && propertyDetails && errorMessage) {
        loadingMessage.classList.add('hidden');
        propertyDetails.classList.add('hidden');
        errorMessage.classList.remove('hidden');
        errorMessage.innerHTML = `${message} <br><a href="index.html" class="text-blue-600 underline">Volver al inicio</a>`;
      }
    }

    window.loadPropertyDetails = async function() {
      showLoading(true);
      const urlParams = new URLSearchParams(window.location.search);
      const slug = urlParams.get('slug');
      console.log("Slug recibido:", slug);

      if (!slug) {
        showError("Propiedad no encontrada. Slug no proporcionado.");
        return;
      }

      try {
        console.log("Realizando consulta por slug:", slug);
        const q = query(collection(db, "propiedades"), where("slug", "==", slug));
        const querySnapshot = await getDocs(q);
        console.log("Resultados de la consulta:", querySnapshot.size, "documentos encontrados");

        if (!querySnapshot.empty) {
          const doc = querySnapshot.docs[0];
          propertyId = doc.id;
          const property = doc.data();
          console.log("Propiedad encontrada:", property);

          const titleElement = document.getElementById('modalTitle');
          if (titleElement) titleElement.textContent = property.title || "Sin título";

          const priceElement = document.getElementById('modalPriceValue');
          if (priceElement) priceElement.textContent = property.price ? property.price.toLocaleString() : "Consultar";

          const currencyElement = document.getElementById('modalCurrency');
          let currencySymbol = 'ARS $';
          if (currencyElement) {
            switch(property.currency) {
              case 'USD': currencySymbol = 'USD '; currencyElement.textContent = 'USD '; break;
              case 'EUR': currencySymbol = '€'; currencyElement.textContent = '€'; break;
              default: currencySymbol = 'ARS $'; currencyElement.textContent = 'ARS $';
            }
          }

          const typeBadge = document.getElementById('modalTypeBadge');
          if (typeBadge) typeBadge.textContent = property.type ? property.type.charAt(0).toUpperCase() + property.type.slice(1) : "Sin tipo";

          const operationBadge = document.getElementById('modalOperationBadge');
          if (operationBadge) operationBadge.textContent = property.operation === 'comprar' ? 'Venta' : 'Alquiler';

          const locationBadge = document.getElementById('modalLocationBadge');
          if (locationBadge) locationBadge.textContent = property.location || "Sin ubicación";

          const mainImage = document.getElementById('mainImage');
          window.images = Array.isArray(property.images) && property.images.length > 0 ? property.images : ['https://placehold.co/300x200'];
          if (mainImage) mainImage.src = window.images[0];

          const thumbnailContainer = document.getElementById('thumbnailContainer');
          if (thumbnailContainer) {
            thumbnailContainer.innerHTML = '';
            window.images.forEach((image, index) => {
              const thumbnail = document.createElement('img');
              thumbnail.src = image;
              thumbnail.alt = `Miniatura ${index + 1}`;
              thumbnail.className = `thumbnail ${index === 0 ? 'active' : ''}`;
              thumbnail.onclick = () => {
                window.currentImageIndex = index;
                window.updateMainImage();
              };
              thumbnailContainer.appendChild(thumbnail);
            });
          }

          const locationDetail = document.getElementById('modalLocation');
          if (locationDetail) locationDetail.textContent = property.location || "Sin ubicación";

          const squareMeters = document.getElementById('modalSquareMeters');
          if (squareMeters) squareMeters.textContent = `${property.squareMeters || 0} m²`;

          const bedrooms = document.getElementById('modalBedrooms');
          if (bedrooms) bedrooms.textContent = `${property.bedrooms || 0} dormitorio/s`;

          const bathrooms = document.getElementById('modalBathrooms');
          if (bathrooms) bathrooms.textContent = `${property.bathrooms || 0} baño/s`;

          const description = document.getElementById('modalDescription');
          if (description) description.textContent = property.detailedDescription || property.description || "Sin descripción";

          const owner = document.getElementById('modalOwner');
          if (owner) owner.textContent = property.owner || "Sin propietario";

          const ownerName = document.getElementById('ownerName');
          if (ownerName) ownerName.textContent = property.owner || "Sin nombre";

          const phone = document.getElementById('modalPhone');
          if (phone) phone.textContent = property.phone || "Sin teléfono";

          const phoneNumber = document.getElementById('phoneNumber');
          if (phoneNumber) phoneNumber.textContent = property.phone || "Sin número";

          const whatsappLink = document.getElementById('modalWhatsApp');
          if (whatsappLink && property.phone) {
            const message = `Hola, estoy interesado en la propiedad "${property.title || 'Sin título'}" en ${property.location || 'Sin ubicación'} por ${currencySymbol}${property.price ? property.price.toLocaleString() : 'Consultar'}. ¿Podemos hablar más detalles?`;
            const encodedMessage = encodeURIComponent(message);
            whatsappLink.href = `https://wa.me/${property.phone}?text=${encodedMessage}`;
          } else if (whatsappLink) {
            whatsappLink.href = '#';
            whatsappLink.classList.add('opacity-50', 'pointer-events-none');
            whatsappLink.title = 'Número de teléfono no disponible';
          }

          const favoriteButton = document.getElementById('favoriteButton');
          if (favoriteButton) {
            favoriteButton.setAttribute('data-property-id', propertyId);
            favoriteButton.classList.toggle('favorited', isPropertyInFavorites(propertyId));
            favoriteButton.setAttribute('aria-label', isPropertyInFavorites(propertyId) ? 'Remover de favoritos' : 'Añadir a favoritos');
            favoriteButton.onclick = (event) => {
              toggleFavoriteProperty(propertyId, event);
              favoriteButton.classList.toggle('favorited', isPropertyInFavorites(propertyId));
              favoriteButton.setAttribute('aria-label', isPropertyInFavorites(propertyId) ? 'Remover de favoritos' : 'Añadir a favoritos');
              updateFavoritesCounter();
            };
          }

          showLoading(false);
        } else {
          showError("Propiedad no encontrada con slug: " + slug + ". Verifica que el slug exista en la colección 'propiedades' de Firestore.");
          console.log("Verifica que el slug '" + slug + "' exista en la colección 'propiedades' de Firestore.");
        }
      } catch (error) {
        console.error("Error al cargar propiedad:", error);
        showError("Error al cargar la propiedad: " + error.message + ". Por favor, intenta de nuevo o contacta al soporte.");
        if (error.code === 'permission-denied') {
          console.log("Revisa las reglas de seguridad en Firestore. Asegúrate de que la colección 'propiedades' permita lecturas.");
        }
      }
    };

    let currentImageIndex = 0;
    let images = [];

    window.updateMainImage = function() {
      const mainImage = document.getElementById('mainImage');
      if (mainImage) {
        mainImage.src = window.images[currentImageIndex];
        mainImage.alt = `Imagen ${currentImageIndex + 1}`;
      }

      const thumbnails = document.querySelectorAll('.thumbnail');
      thumbnails.forEach((thumbnail, index) => {
        thumbnail.classList.toggle('active', index === currentImageIndex);
      });
    };

    window.prevImage = function() {
      currentImageIndex = (currentImageIndex - 1 + window.images.length) % window.images.length;
      window.updateMainImage();
    };

    window.nextImage = function() {
      currentImageIndex = (currentImageIndex + 1) % window.images.length;
      window.updateMainImage();
    };

    window.toggleAccordion = function(id) {
      const panel = document.getElementById(`panel-${id}`);
      const icon = document.getElementById(`icon-${id}`);
      if (panel && icon) {
        if (panel.classList.contains('hidden')) {
          panel.classList.remove('hidden');
          icon.textContent = '−';
        } else {
          panel.classList.add('hidden');
          icon.textContent = '+';
        }
      } else {
        console.error(`Panel o icono no encontrado para id: ${id}`);
      }
    };

    function setupImageModal() {
      const modal = document.getElementById('imageModal');
      const modalImg = document.getElementById('modalImage');
      const mainImage = document.getElementById('mainImage');
      const closeBtn = document.getElementsByClassName('close')[0];

      if (mainImage && modal && modalImg && closeBtn) {
        mainImage.onclick = function() {
          modal.style.display = 'flex';
          modalImg.src = window.images[currentImageIndex];
        };

        closeBtn.onclick = function() {
          modal.style.display = 'none';
        };

        modal.onclick = function(event) {
          if (event.target === modal) {
            modal.style.display = 'none';
          }
        };
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      console.log("DOM cargado, iniciando loadPropertyDetails...");
      window.loadPropertyDetails();
      setupImageModal();
      try {
        updateFavoritesCounter();
      } catch (error) {
        console.error("Error al actualizar el contador de favoritos:", error);
      }

      const copyBtn = document.getElementById('copyLinkButton');
      copyBtn?.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(window.location.href);
          showToast('¡Enlace copiado al portapapeles!', 'success');
        } catch (err) {
          console.error('Error al copiar:', err);
          showToast('Hubo un problema al copiar el enlace.', 'warning');
        }
      });
    });
  </script>
</body>
</html>